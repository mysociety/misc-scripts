#!/bin/sh
# Shorter interface to deploy scripts on servers.

die () {
    echo "mysociety:" "$@" 1>&2
    exit 1
}

show_help () {
	cat <<END
Usage: mysociety COMMAND [OPTIONS]

COMMAND is one of:
    config
        Deploy new config for current server from /data/servers/...

    vhost VHOST
        Deploy latest version of VHOST, e.g. www.pledgebank.com.

    dns
        Update the DNS configuration on the current host.
  
Extra parameters are passed through to underlying deploy-... script.
END
	exit
}

COMMAND=$1
shift || die "specify a command (try --help for help)"

set -e

case $COMMAND in
    config)
	HOST=`hostname`
        if [ x$HOST = x ] ; then
            die "can't establish hostname"
        fi

        case $HOST in
            tea|bitter)
                ARCHETYPE=bitter
                ;;
            *)
                die "don't know how to configure this host ($HOST)"
                ;;
        esac

	    /data/mysociety/bin/deploy-configuration /data/servers/$ARCHETYPE /data/servers/$HOST.pl "$@"
        cp /data/servers/$HOST.pl "/etc/mysociety/config-settings.pl"
        ;;
        
    vhost)
        VHOST=$1
        shift || die "specify a virtual host"
        exec /data/mysociety/bin/deploy-vhost $VHOST "$@"
        ;;

    dns)
        exec /data/mysociety/bin/deploy-dns "$@"
        ;;

    *)
	show_help
        ;;
esac

