#!/bin/bash
# Shorter interface to deploy scripts on servers.
# Bash script because it uses temporary named pipes <(cmd)

die () {
    echo "mysociety:" "$@" 1>&2
    exit 1
}

show_help () {
	cat <<END
Usage: mysociety COMMAND [OPTIONS]

COMMAND is one of:
    config
        Deploy new config for current server from /data/servers/...

    vhost VHOST
        Deploy latest version of VHOST, e.g. www.pledgebank.com.

    dns
        Update the DNS configuration on the current host.

    catlog VHOST access
        Cats the latest VHOST log file from every server, merging them
        
Extra parameters are passed through to underlying deploy-... script.
END
	exit
}

COMMAND=$1
shift || die "specify a command (try --help for help)"

set -e

case $COMMAND in
    config)
	HOST=`hostname`
        if [ x$HOST = x ] ; then
            die "can't establish hostname"
        fi

        case $HOST in
            tea|bitter)
                ARCHETYPE=bitter
                ;;
            *)
                die "don't know how to configure this host ($HOST)"
                ;;
        esac

	    /data/mysociety/bin/deploy-configuration /data/servers/$ARCHETYPE /data/servers/$HOST.pl "$@"
        cp /data/servers/$HOST.pl "/etc/mysociety/config-settings.pl"
        ;;
        
    vhost)
        VHOST=$1
        shift || die "specify a virtual host"
        # deploy vhost
        /data/mysociety/bin/deploy-vhost $VHOST "$@"
        # special code to set up dademcron user and cron job
        if [ "$VHOST" = "services.mysociety.org" -a $( hostname ) = bitter ]; then
            /data/vhost/services.mysociety.org/mysociety/services/DaDem/bin/setup-dademcron
        fi
        ;;

    dns)
        exec /data/mysociety/bin/deploy-dns "$@"
        ;;

    email)
        exec /data/mysociety/bin/deploy-email "$@"
        ;;

    catlog)
        VHOST=$1
        shift || die "specify a virtual host"
        TYPE=$1
        shift || die "specify 'access' or 'error'"
        mergelog <(ssh bitter.ukcod.org.uk cat /data/vhost/$VHOST/logs/${TYPE}_log) <(ssh tea.ukcod.org.uk cat /data/vhost/$VHOST/logs/${TYPE}_log)
        ;;

    *)
	show_help
        ;;
esac

