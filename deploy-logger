#!/bin/sh
#
# deploy-logger:
# Call to log whenever a deploy action happens.
#
# Arguments are the message to log, as in echo(1).
#
# $Id: deploy-logger,v 1.10 2012-05-31 09:51:09 matthew Exp $
#

HOST=`hostname`
STATE_PATH=/data/servers/state
LOGFILE=deploy-log
DATELOG=`date +"%Y-%m-%d %X"`
WHO=$SUDO_USER
[ "$WHO" = "" ] && WHO=$USER

if [ "$1" = "-u" ] ; then
    UML=1
    shift
fi

# Create and add to CVS if we're a new server
if [ ! -e "$STATE_PATH/$HOST" ]
then
    cd $STATE_PATH
    mkdir $HOST
    if [ x = x$UML ]
    then
        cvs add $HOST
    fi
fi
cd $STATE_PATH/$HOST
if [ ! -e "$LOGFILE" ]
then
    touch $LOGFILE
    if [ x = x$UML ]
    then
        cvs add $LOGFILE
    fi
fi

# Add new entry to end of log file
echo "$DATELOG $WHO-" "$@" >>$LOGFILE

# Post notice to IRC about log entry.
# Backgrounded due to ident delay
(( echo nick $HOST; echo user $HOST 8 "*" :mySociety IRCBot; echo notice "#activity" :"$WHO $@"; echo quit; ) | nc irc.mysociety.org 6667 >/dev/null &) 2>/dev/null

# Commit it
if [ x = x$UML ]
then
    cvs -Q commit -m "deploy-logger: $@" $LOGFILE | grep -v "Mailing the commit message to"
fi

exit 0 # otherwise it exits with code of grep

