#
# firewall:
# Template iptables firewall script.
#
# $Id: firewall,v 1.2 2005-12-01 12:07:59 chris Exp $
#

# Services we allow
tcp_allowed_services="ssh smtp http"
udp_allowed_services="domain ntp"
udp_allowed_services="snmp"

# What to do with packets we don't like.
disallow=REJECT

# Interface and address to which we apply the rules.
public_interface=eth0

# Get into a known state by flushing all the chains.
iptables -F INPUT
iptables -F OUTPUT
iptables -F FORWARD

#
# Public interface
#

# TCP
for port in $tcp_allowed_services ; do
    iptables -A INPUT -p tcp --syn -i $public_interface --destination-port $port -j ACCEPT
done

# Discard all else
iptables -A INPUT -p tcp --syn -i $public_interface -j $disallow

# UDP
for port in $udp_allowed_services ; do
    iptables -A INPUT -p udp -i $public_interface --destination-port $port -j ACCEPT
done

# Since this machine does not run a cacheing name server, we must also allow
# any traffic to/from our selected DNS servers.
awk '/^nameserver / { print $2 }' /etc/resolv.conf | while read host ; do
    iptables -A INPUT -p udp -i $public_interface --source-port domain --source $host -j ACCEPT
done

iptables -A INPUT -p udp -i $public_interface -j $disallow

# Discard anything forwarded
iptables -A FORWARD -j $disallow
